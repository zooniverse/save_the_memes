// Generated by CoffeeScript 1.4.0
(function() {
  var loadKey;

  loadKey = function(key) {
    return unescape(window.location.search.replace(new RegExp("^(?:.*[&\\?]" + escape(key).replace(/[\.\+\*]/g, "\\$&") + "(?:\\=([^&]*))?)?.*$", "i"), "$1")) || false;
  };

  $(function() {
    var downloadButton, form, handleGenerate, happyStoryBackground, imageContainer, imageUrlInput, img, isHappy, randomElement, sadStoryBackground, storyButton, url;
    $.scrollIt();
    form = $('#generate-form').get(0);
    imageContainer = $('#image-container');
    imageUrlInput = $('#image-url');
    downloadButton = $('#download');
    while ($('.perk-slider li.active').length < 4) {
      randomElement = Math.floor(Math.random() * $('.perk-slider li:not(.active)').length);
      $('.perk-slider li:not(.active)').eq(randomElement).addClass('active');
    }
    if ((url = loadKey('u')) && (url.indexOf('www.snapshotserengeti.org'))) {
      img = new Image;
      img.onload = function() {
        imageContainer.html(img);
        imageUrlInput.css('display', 'none');
        return imageUrlInput.val(url);
      };
      img.src = url;
    } else {
      console.log('no valid url');
    }
    handleGenerate = function(e) {
      var loading, request;
      e.preventDefault();
      request = $.ajax({
        type: 'POST',
        url: '/',
        data: {
          url: form[0].value,
          topText: form[1].value,
          bottomText: form[2].value
        }
      });
      imageContainer.html('');
      loading = new Spinner().spin(imageContainer.get(0));
      request.done(function(_arg) {
        var url;
        url = _arg.url;
        img = new Image;
        img.onload = function() {
          loading.stop();
          imageContainer.html(img);
          downloadButton.show();
          return downloadButton.parent().first().attr('href', url);
        };
        img.src = url;
        return console.log('request success');
      });
      return request.fail(function() {
        return console.log('failure');
      });
    };
    $('#generate').on('click', handleGenerate);
    $('#generate-form input').keypress(function(e) {
      if (e.which === 13) {
        e.preventDefault();
        return handleGenerate(e);
      }
    });
    isHappy = true;
    happyStoryBackground = $('#happy-story-background');
    sadStoryBackground = $('#sad-story-background');
    storyButton = $('#lets-watch');
    storyButton.on('click', function(e) {
      if (isHappy) {
        happyStoryBackground.fadeOut(700);
        sadStoryBackground.fadeIn(700);
        isHappy = false;
        return storyButton.html('Oh No!');
      } else {
        happyStoryBackground.fadeIn(700);
        sadStoryBackground.fadeOut(700);
        isHappy = true;
        return storyButton.html('Let\'s Watch!');
      }
    });
    return $(window).on('scroll', function(e) {
      var navigation;
      navigation = $('#navigation');
      if ($(window).scrollTop() > '800') {
        return navigation.css({
          "position": "fixed",
          "top": "0"
        });
      } else {
        return navigation.attr('style', '');
      }
    });
  });

}).call(this);
