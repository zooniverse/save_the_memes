// Generated by CoffeeScript 1.4.0
(function() {
  var campaignProgress, campaignTotal, formatNumber, loadKey, serengetiImages;

  loadKey = function(key) {
    return unescape(window.location.search.replace(new RegExp("^(?:.*[&\\?]" + escape(key).replace(/[\.\+\*]/g, "\\$&") + "(?:\\=([^&]*))?)?.*$", "i"), "$1")) || false;
  };

  formatNumber = function(n) {
    if (!n) {
      return n;
    }
    return n.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,');
  };

  Array.prototype.shuffle = function() {
    var i, m, t;
    m = this.length;
    while (m) {
      i = Math.floor(Math.random() * m--);
      t = this[m];
      this[m] = this[i];
      this[i] = t;
    }
    return this;
  };

  serengetiImages = ['http://www.snapshotserengeti.org/subjects/standard/51e904fee0053a09c30b735c_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/51a39bcfe18f49172b19777c_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/51a332d6e18f49172b0cfe6f_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/51e8ed42e0053a09c308b433_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/51e8a9afe0053a09c300ea30_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/51a3528ae18f49172b10c2b2_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/51a37abae18f49172b15876b_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/50c214508a607540b9038e41_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/50c213e98a607540b9033aff_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/50c2104f8a607540b90033c4_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/50c2163b8a607540b904f94b_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/50c219198a607540b9071e73_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/50c217ce8a607540b90627be_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/50c211e68a607540b90187a0_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/50c2113a8a607540b900f706_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/50c217708a607540b905d640_0.jpg'].shuffle();

  campaignProgress = 6900;

  campaignTotal = 33000;

  $(function() {
    var column, downloadButton, form, fragment, handleGenerate, happyStoryBackground, i, imageContainer, imageUrlInput, img, isHappy, navigation, progressAmount, progressContainer, randomElement, request, sadStoryBackground, setMeter, stage, storyButton, url, _i;
    $.scrollIt();
    form = $('#generate-form').get(0);
    imageContainer = $('#image-container');
    imageUrlInput = $('#image-url');
    downloadButton = $('#download');
    progressContainer = $('#progress-container');
    progressAmount = $('#progress-amount');
    setMeter = function(campaignProgress) {
      progressContainer.css('height', ((campaignProgress / campaignTotal) * 100) + '%');
      return progressAmount.html(formatNumber(campaignProgress));
    };
    request = $.ajax({
      url: 'http://indy-go-go.herokuapp.com/',
      dataType: 'text'
    });
    request.done(function(campaignProgress) {
      return setMeter(Number(campaignProgress.replace(/[^0-9\.]+/g, "")));
    });
    request.fail(function() {
      return setMeter(campaignProgress);
    });
    while ($('.perk-slider li.active').length < 4) {
      randomElement = Math.floor(Math.random() * $('.perk-slider li:not(.active)').length);
      $('.perk-slider li:not(.active)').eq(randomElement).addClass('active');
    }
    if ((url = loadKey('u')) && (url.indexOf('www.snapshotserengeti.org'))) {
      stage = $('#stage-two');
      img = new Image;
      img.onload = function() {
        imageContainer.html(img);
        return imageUrlInput.val(url);
      };
      img.src = url;
    } else {
      stage = $('#stage-one');
      fragment = document.createDocumentFragment();
      for (i = _i = 0; _i <= 11; i = ++_i) {
        img = new Image;
        img.src = serengetiImages[i];
        column = document.createElement('div');
        column.className = 'column';
        column.appendChild(img);
        fragment.appendChild(column);
      }
      $('#preset-images').append(fragment);
      stage.on('click', 'img', function(e) {
        var newStage;
        newStage = $('#stage-two');
        stage.hide();
        newStage.show();
        imageContainer.html(e.currentTarget);
        return imageUrlInput.val(e.currentTarget.src);
      });
    }
    stage.show();
    handleGenerate = function(e) {
      var loading;
      e.preventDefault();
      request = $.ajax({
        type: 'POST',
        url: '/',
        data: {
          url: form[0].value,
          topText: form[1].value,
          bottomText: form[2].value
        }
      });
      imageContainer.html('');
      loading = new Spinner().spin(imageContainer.get(0));
      request.done(function(_arg) {
        var url;
        url = _arg.url;
        img = new Image;
        img.onload = function() {
          loading.stop();
          imageContainer.html(img);
          downloadButton.show();
          return downloadButton.parent().first().attr('href', url);
        };
        return img.src = url;
      });
      return request.fail(function() {
        return imageContainer.html('<span>error :(</span>');
      });
    };
    $('#generate').on('click', handleGenerate);
    $('#generate-form input').keypress(function(e) {
      if (e.which === 13) {
        e.preventDefault();
        return handleGenerate(e);
      }
    });
    isHappy = true;
    happyStoryBackground = $('#happy-story-background');
    sadStoryBackground = $('#sad-story-background');
    storyButton = $('#lets-watch');
    storyButton.on('click', function(e) {
      if (isHappy) {
        happyStoryBackground.fadeOut(700);
        sadStoryBackground.fadeIn(700);
        isHappy = false;
        return storyButton.html('Oh No!');
      } else {
        happyStoryBackground.fadeIn(700);
        sadStoryBackground.fadeOut(700);
        isHappy = true;
        return storyButton.html('Let\'s Watch!');
      }
    });
    navigation = $('#navigation');
    return $(window).on('scroll', function(e) {
      if ($(window).scrollTop() > '800') {
        return navigation.css({
          "position": "fixed",
          "top": "0"
        });
      } else {
        return navigation.attr('style', '');
      }
    });
  });

}).call(this);
