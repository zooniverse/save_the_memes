// Generated by CoffeeScript 1.4.0
(function() {
  var CAMPAIGN_PROGRESS, CAMPAIGN_TOTAL, facebookHref, formatNumber, loadKey, pinterestHref, serengetiImages, socialImage, socialMessage, socialTitle, twitterHref;

  loadKey = function(key) {
    return unescape(window.location.search.replace(new RegExp("^(?:.*[&\\?]" + escape(key).replace(/[\.\+\*]/g, "\\$&") + "(?:\\=([^&]*))?)?.*$", "i"), "$1")) || false;
  };

  formatNumber = function(n) {
    if (!n) {
      return n;
    }
    return n.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,');
  };

  Array.prototype.shuffle = function() {
    var i, m, t;
    m = this.length;
    while (m) {
      i = Math.floor(Math.random() * m--);
      t = this[m];
      this[m] = this[i];
      this[i] = t;
    }
    return this;
  };

  socialImage = function(url) {
    var image;
    image = this.location.standard instanceof Array ? this.location.standard[Math.floor(this.location.standard.length / 2)] : this.location.standard;
    return $("<a href='" + image + "'></a>").get(0).href;
  };

  socialTitle = function() {
    return 'Save the Memes';
  };

  socialMessage = function(url) {
    return "Saving the Memes! http://igg.me/at/serengeti/x";
  };

  facebookHref = function(url) {
    return ("https://www.facebook.com/sharer/sharer.php\n?s=100\n&p[url]=" + (encodeURIComponent(url)) + "\n&p[title]=" + (encodeURIComponent(socialTitle())) + "\n&p[summary]=" + (encodeURIComponent(socialMessage(url))) + "\n&p[images][0]=" + (socialMessage(url))).replace('\n', '', 'g');
  };

  twitterHref = function(url) {
    var status;
    status = "" + (socialMessage(url)) + " " + url;
    return "http://twitter.com/home?status=" + (encodeURIComponent(status));
  };

  pinterestHref = function(url) {
    return ("http://pinterest.com/pin/create/button/\n?url=" + (encodeURIComponent(url)) + "\n&media=" + (encodeURIComponent(socialImage(url))) + "\n&description=" + (encodeURIComponent(socialMessage(url)))).replace('\n', '', 'g');
  };

  serengetiImages = ['http://www.snapshotserengeti.org/subjects/standard/51e904fee0053a09c30b735c_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/51a39bcfe18f49172b19777c_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/51a332d6e18f49172b0cfe6f_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/51e8ed42e0053a09c308b433_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/51e8a9afe0053a09c300ea30_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/51a3528ae18f49172b10c2b2_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/51a37abae18f49172b15876b_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/50c214508a607540b9038e41_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/50c213e98a607540b9033aff_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/50c2104f8a607540b90033c4_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/50c2163b8a607540b904f94b_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/50c219198a607540b9071e73_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/50c217ce8a607540b90627be_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/50c211e68a607540b90187a0_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/50c2113a8a607540b900f706_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/50c217708a607540b905d640_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/51a33cdfe18f49172b0e2d3d_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/51a32982e18f49172b0be0ee_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/50c213158a607540b90290f9_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/51e8dcb1e0053a09c306cabf_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/50c2171a8a607540b9059380_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/50c211a58a607540b90151e2_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/50c2110a8a607540b900ced4_0.jpg', 'http://www.snapshotserengeti.org/subjects/standard/50c210c28a607540b9009237_0.jpg'].shuffle();

  CAMPAIGN_PROGRESS = 6900;

  CAMPAIGN_TOTAL = 33000;

  $(function() {
    var column, downloadButton, form, fragment, handleGenerate, happyStoryBackground, i, imageContainer, imageUrlInput, img, isHappy, navigation, progressAmount, progressContainer, randomElement, sadStoryBackground, setMeter, socialLinks, stage, storyButton, url, _i;
    $.scrollIt();
    form = $('#generate-form').get(0);
    imageContainer = $('#image-container');
    imageUrlInput = $('#image-url');
    downloadButton = $('#download');
    socialLinks = $('#social-links');
    progressContainer = $('#progress-container');
    progressAmount = $('#progress-amount');
    setMeter = function(campaignProgress) {
      progressContainer.css('height', ((campaignProgress / CAMPAIGN_TOTAL) * 100) + '%');
      return progressAmount.html(formatNumber(campaignProgress));
    };
    window.callback = function(campaignProgress) {
      if (typeof campaignProgress !== 'boolean') {
        return setMeter(Number(campaignProgress.replace(/[^0-9\.]+/g, "")));
      } else {
        return setMeter(CAMPAIGN_PROGRESS);
      }
    };
    $.ajax({
      url: 'http://indy-go-go.herokuapp.com/',
      dataType: 'jsonp'
    });
    while ($('.perk-slider li.active').length < 4) {
      randomElement = Math.floor(Math.random() * $('.perk-slider li:not(.active)').length);
      $('.perk-slider li:not(.active)').eq(randomElement).addClass('active');
    }
    if ((url = loadKey('u')) && (url.indexOf('www.snapshotserengeti.org'))) {
      stage = $('#stage-two');
      img = new Image;
      img.onload = function() {
        imageContainer.html(img);
        return imageUrlInput.val(url);
      };
      img.src = url;
    } else {
      stage = $('#stage-one');
      fragment = document.createDocumentFragment();
      for (i = _i = 0; _i <= 11; i = ++_i) {
        img = new Image;
        img.src = serengetiImages[i];
        column = document.createElement('div');
        column.className = 'column';
        column.appendChild(img);
        fragment.appendChild(column);
      }
      $('#preset-images').append(fragment);
      stage.on('click', 'img', function(e) {
        var newStage;
        newStage = $('#stage-two');
        stage.hide();
        newStage.show();
        imageContainer.html(e.currentTarget);
        return imageUrlInput.val(e.currentTarget.src);
      });
    }
    stage.show();
    handleGenerate = function(e) {
      var loading, request;
      e.preventDefault();
      request = $.ajax({
        type: 'POST',
        url: '/',
        data: {
          url: form[0].value,
          topText: form[1].value,
          bottomText: form[2].value
        }
      });
      imageContainer.html('');
      loading = new Spinner().spin(imageContainer.get(0));
      request.done(function(_arg) {
        var url;
        url = _arg.url;
        img = new Image;
        img.onload = function() {
          loading.stop();
          imageContainer.html(img);
          downloadButton.show();
          downloadButton.parent().first().attr('href', url);
          socialLinks.show();
          $('#facebook-link').attr('href', facebookHref(url));
          $('#twitter-link').attr('href', twitterHref(url));
          return $('#pinterest-link').attr('href', pinterestHref(url));
        };
        return img.src = url;
      });
      return request.fail(function() {
        return imageContainer.html('<span>error :(</span>');
      });
    };
    $('#generate').on('click', handleGenerate);
    $('#generate-form input').keypress(function(e) {
      if (e.which === 13) {
        e.preventDefault();
        return handleGenerate(e);
      }
    });
    isHappy = true;
    happyStoryBackground = $('#happy-story-background');
    sadStoryBackground = $('#sad-story-background');
    storyButton = $('#lets-watch');
    storyButton.on('click', function(e) {
      if (isHappy) {
        happyStoryBackground.fadeOut(700);
        sadStoryBackground.fadeIn(700);
        isHappy = false;
        return storyButton.html('Oh No!');
      } else {
        happyStoryBackground.fadeIn(700);
        sadStoryBackground.fadeOut(700);
        isHappy = true;
        return storyButton.html('Let\'s Watch!');
      }
    });
    navigation = $('#navigation');
    return $(window).on('scroll', function(e) {
      if ($(window).scrollTop() > '800') {
        return navigation.css({
          "position": "fixed",
          "top": "0"
        });
      } else {
        return navigation.attr('style', '');
      }
    });
  });

}).call(this);
